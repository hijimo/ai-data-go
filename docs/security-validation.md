# 安全验证和输入检查

本文档描述了模型提供商API服务中实现的安全验证和输入检查功能。

## 概述

为了防止安全漏洞和恶意输入，系统在以下两个层面实现了输入验证和安全检查：

1. **API处理器层**：验证HTTP请求中的路径参数
2. **数据加载器层**：验证文件系统操作中的路径安全性

## API处理器层验证

### 实现位置

- `pkg/validator/path_validator.go` - 路径验证工具
- `internal/api/handler/provider_handler.go` - 处理器中的验证调用

### 验证规则

#### 提供商ID验证 (`ValidateProviderID`)

- **长度限制**：1-100个字符
- **允许的字符**：字母、数字、下划线（_）、连字符（-）、点号（.）
- **禁止的模式**：
  - 路径遍历模式（`..`、`./`、`../`、`/..`）
  - 路径分隔符（`/`、`\`）
  - 空字节（`\x00`）

#### 模型ID验证 (`ValidateModelID`)

- 与提供商ID使用相同的验证规则
- 支持复杂的模型命名，如：`gemini-1.5-pro`、`qwen2.5-72b-instruct`

### 错误响应

当验证失败时，API返回：

- **HTTP状态码**：400 (Bad Request)
- **错误码**：422 (CodeValidationError)
- **错误消息**：描述具体的验证失败原因

示例响应：

```json
{
  "code": 422,
  "message": "providerId: 格式无效，只允许字母、数字、下划线、连字符和点号",
  "data": null
}
```

## 数据加载器层安全检查

### 实现位置

- `internal/loader/model_loader.go` - 加载器中的路径安全检查

### 安全措施

#### 1. 路径清理

所有文件系统路径在使用前都会通过 `filepath.Clean()` 进行清理。

#### 2. 路径安全验证 (`validatePathSafety`)

确保所有文件访问都在允许的基础目录内：

- 使用 `filepath.Abs()` 获取绝对路径
- 验证目标路径是否在基础目录内
- 检查相对路径中是否包含 `..` 父目录引用

#### 3. ID验证

在加载过程中验证提供商ID和模型ID：

- 提供商文件夹名称必须通过 `ValidateProviderID` 验证
- 模型文件名称必须通过 `ValidateModelID` 验证
- 不符合规则的文件会被跳过并记录警告日志

### 防护的攻击类型

1. **目录遍历攻击**：防止访问基础目录之外的文件
2. **路径注入**：防止通过特殊字符注入恶意路径
3. **符号链接攻击**：通过绝对路径验证防止符号链接逃逸

## 测试覆盖

### 单元测试

- `pkg/validator/path_validator_test.go` - 路径验证器测试
- `internal/api/handler/provider_handler_validation_test.go` - 处理器验证测试

### 测试场景

1. **有效输入**：
   - 简单的提供商/模型名称
   - 带连字符和下划线的名称
   - 带版本号和日期的名称

2. **无效输入**：
   - 空字符串
   - 包含路径遍历的字符串（`../`）
   - 包含路径分隔符的字符串（`/`、`\`）
   - 包含空格的字符串
   - 超长字符串

3. **路径安全**：
   - 正常的相对路径
   - 包含父目录引用的路径
   - 包含路径遍历的路径

## 配置

### 验证参数

可以在 `pkg/validator/path_validator.go` 中调整以下参数：

```go
const (
    MaxIDLength = 100  // ID的最大长度
    MinIDLength = 1    // ID的最小长度
)
```

### 日志记录

所有验证失败都会记录日志：

- **API层**：使用 WARN 级别记录验证失败
- **加载器层**：使用 WARN 或 ERROR 级别记录路径安全问题

## 最佳实践

1. **始终验证用户输入**：所有来自外部的输入都应该经过验证
2. **使用白名单而非黑名单**：只允许明确定义的字符集
3. **多层防护**：在API层和数据层都进行验证
4. **记录安全事件**：所有验证失败都应该被记录
5. **清晰的错误消息**：向用户提供明确的错误原因

## 未来改进

1. **速率限制**：添加请求速率限制防止暴力攻击
2. **审计日志**：记录所有验证失败的详细信息用于安全审计
3. **自定义验证规则**：支持通过配置文件自定义验证规则
4. **更严格的文件类型检查**：验证YAML文件的内容格式

## 相关文档

- [API接口文档](./api-documentation.md)
- [错误处理规范](./error-handling.md)
- [日志记录规范](./logging.md)
