# 需求文档

## 简介

本功能旨在实现一个模型提供商和模型信息管理系统。系统需要在服务启动时从文件系统加载所有模型提供商及其模型的配置信息到内存中，并通过RESTful API接口对外提供查询服务。该系统将支持多个模型提供商（如通义千问、Gemini等），每个提供商可以提供多种类型的模型（如LLM、TTS、文本嵌入等）。

## 术语表

- **系统**: 指模型提供商API服务系统
- **模型提供商**: 提供AI模型服务的供应商，如通义千问(tongyi)、Gemini等
- **模型类型**: 模型的分类，如llm(大语言模型)、tts(文本转语音)、text_embedding(文本嵌入)、rerank(重排序)、speech2text(语音转文字)等
- **Provider配置**: 存储在provider文件夹下的YAML文件，包含提供商的基本信息和配置
- **Model配置**: 存储在models文件夹下的YAML文件，包含具体模型的详细信息
- **Position文件**: _position.yaml文件，定义了某个模型类型下所有模型的顺序列表
- **内存缓存**: 服务启动时加载到内存中的提供商和模型数据结构

## 需求

### 需求 1: 服务启动时加载提供商数据

**用户故事:** 作为系统管理员，我希望服务启动时自动加载所有模型提供商的配置信息，以便后续快速响应API请求

#### 验收标准

1. 当系统启动时，系统应该扫描models文件夹下的所有子文件夹
2. 当系统发现提供商文件夹时，系统应该读取该文件夹下的provider/[提供商名称].yaml文件
3. 当系统读取provider配置文件时，系统应该将文件夹名称作为"id"字段添加到提供商数据中
4. 当系统完成所有提供商配置读取后，系统应该将数据存储到内存中的providers列表
5. 如果provider配置文件读取失败，则系统应该记录错误日志并继续处理其他提供商

### 需求 2: 服务启动时加载模型数据

**用户故事:** 作为系统管理员，我希望服务启动时自动加载所有模型的配置信息，以便提供完整的模型查询服务

#### 验收标准

1. 当系统加载完提供商数据后，系统应该遍历每个提供商的models字段
2. 当系统处理某个模型类型时，系统应该读取models/[类型]/_position.yaml文件获取模型名称列表
3. 当系统获取到模型名称列表后，系统应该依次读取models/[类型]/[模型名称].yaml文件
4. 当系统读取模型配置文件时，系统应该添加model_type字段标识模型类型
5. 当系统完成某个提供商的所有模型读取后，系统应该将模型数组存储到以提供商id为key的map中
6. 如果_position.yaml文件不存在，则系统应该扫描该类型文件夹下的所有yaml文件（排除_position.yaml）
7. 如果模型配置文件读取失败，则系统应该记录错误日志并继续处理其他模型

### 需求 3: 提供获取提供商列表接口

**用户故事:** 作为API调用者，我希望获取所有模型提供商的列表，以便了解系统支持哪些提供商

#### 验收标准

1. 当客户端发送GET请求到/providers端点时，系统应该返回所有提供商的列表
2. 当系统返回提供商列表时，系统应该包含以下字段：id、background、configurate_methods、help、icon_large、icon_small、label、provider
3. 当系统返回数据时，系统应该使用ResponseData[[]Provider]格式包装响应
4. 当系统成功返回数据时，系统应该设置HTTP状态码为200
5. 如果内存中没有提供商数据，则系统应该返回空数组

### 需求 4: 提供通过ID获取提供商详情接口

**用户故事:** 作为API调用者，我希望通过提供商ID获取其详细信息，以便了解该提供商的完整配置

#### 验收标准

1. 当客户端发送GET请求到/providers/{providerId}端点时，系统应该返回指定提供商的详细信息
2. 当系统找到匹配的提供商时，系统应该返回该提供商YAML文件中的所有字段
3. 当系统返回数据时，系统应该使用ResponseData[Provider]格式包装响应
4. 当系统成功返回数据时，系统应该设置HTTP状态码为200
5. 如果提供商ID不存在，则系统应该返回404状态码和错误信息

### 需求 5: 提供通过提供商ID获取模型列表接口

**用户故事:** 作为API调用者，我希望获取指定提供商的所有模型列表，以便了解该提供商提供哪些模型

#### 验收标准

1. 当客户端发送GET请求到/providers/{providerId}/models端点时，系统应该返回该提供商的所有模型列表
2. 当系统返回模型列表时，系统应该包含以下字段：model、label、model_type、features、model_properties、parameter_rules、pricing
3. 当系统返回数据时，系统应该使用ResponseData[[]Model]格式包装响应
4. 当系统成功返回数据时，系统应该设置HTTP状态码为200
5. 如果提供商ID不存在，则系统应该返回404状态码和错误信息
6. 如果提供商存在但没有模型，则系统应该返回空数组

### 需求 6: 提供通过模型名称获取模型详情接口

**用户故事:** 作为API调用者，我希望通过模型名称获取其详细信息，以便了解该模型的完整配置

#### 验收标准

1. 当客户端发送GET请求到/providers/{providerId}/models/{modelId}端点时，系统应该返回指定模型的详细信息
2. 当系统找到匹配的模型时，系统应该返回该模型YAML文件中的所有字段
3. 当系统返回数据时，系统应该使用ResponseData[Model]格式包装响应
4. 当系统成功返回数据时，系统应该设置HTTP状态码为200
5. 如果提供商ID不存在，则系统应该返回404状态码和错误信息
6. 如果模型ID不存在，则系统应该返回404状态码和错误信息

### 需求 7: 提供获取模型参数规则接口

**用户故事:** 作为API调用者，我希望获取指定模型的参数规则，以便了解如何正确配置和调用该模型

#### 验收标准

1. 当客户端发送GET请求到/providers/{providerId}/models/{modelId}/parameter-rules端点时，系统应该返回该模型的参数规则
2. 当系统找到匹配的模型时，系统应该返回模型配置中的parameter_rules字段内容
3. 当系统返回数据时，系统应该使用ResponseData[[]ParameterRule]格式包装响应
4. 当系统成功返回数据时，系统应该设置HTTP状态码为200
5. 如果提供商ID不存在，则系统应该返回404状态码和错误信息
6. 如果模型ID不存在，则系统应该返回404状态码和错误信息
7. 如果模型没有parameter_rules字段，则系统应该返回空数组

### 需求 8: 错误处理和日志记录

**用户故事:** 作为系统管理员，我希望系统能够妥善处理各种错误情况并记录日志，以便排查问题和监控系统运行状态

#### 验收标准

1. 当系统启动加载数据时，系统应该记录加载开始和完成的日志
2. 当系统遇到文件读取错误时，系统应该记录详细的错误信息包括文件路径和错误原因
3. 当系统遇到YAML解析错误时，系统应该记录详细的错误信息包括文件路径和解析错误详情
4. 当API请求参数无效时，系统应该返回400状态码和清晰的错误描述
5. 当API请求的资源不存在时，系统应该返回404状态码和清晰的错误描述
6. 当系统发生内部错误时，系统应该返回500状态码并记录详细的错误堆栈信息
