# 实现计划

- [x] 1. 定义数据模型和错误类型
  - 在 `internal/model/` 目录下创建提供商和模型的数据结构
  - 定义 Provider、Model、ParameterRule 等核心数据类型
  - 在 `pkg/errors/` 目录下添加模型提供商相关的错误码和错误消息
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_

- [x] 2. 实现内存存储层
  - 创建 `internal/storage/memory_store.go` 文件
  - 实现 MemoryStore 结构体，使用 map 存储提供商和模型数据
  - 使用 sync.RWMutex 实现并发安全的读写操作
  - 实现 SetProviders、GetProviders、GetProvider、SetModels、GetModels、GetModel 等方法
  - _需求: 1.4, 2.5_

- [x] 3. 实现数据加载器
  - 创建 `internal/loader/model_loader.go` 文件
  - 实现 LoadProviders 方法：扫描 models 目录，读取每个提供商的 provider yaml 文件
  - 实现 LoadModels 方法：根据提供商的 models 字段定义，加载各类型的模型配置
  - 处理 _position.yaml 文件，如果不存在则扫描目录下所有 yaml 文件
  - 实现完整的错误处理和日志记录
  - 实现 LoadAll 方法：协调提供商和模型的完整加载流程
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 8.1, 8.2, 8.3_

- [x] 4. 实现服务层
  - 创建 `internal/service/provider_service.go` 文件
  - 实现 GetAllProviders 方法：返回所有提供商的列表项（仅包含指定字段）
  - 实现 GetProviderByID 方法：根据 ID 获取提供商完整信息
  - 实现 GetProviderModels 方法：获取提供商的所有模型列表项（仅包含指定字段）
  - 实现 GetProviderModel 方法：获取指定模型的完整信息
  - 实现 GetModelParameterRules 方法：获取模型的参数规则
  - 处理各种错误情况（提供商不存在、模型不存在等）
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x] 5. 实现API处理器层
  - 创建 `internal/api/handlers/provider_handler.go` 文件
  - 实现 GetProviders 处理器：处理 GET /providers 请求
  - 实现 GetProviderByID 处理器：处理 GET /providers/{providerId} 请求
  - 实现 GetProviderModels 处理器：处理 GET /providers/{providerId}/models 请求
  - 实现 GetProviderModel 处理器：处理 GET /providers/{providerId}/models/{modelId} 请求
  - 实现 GetModelParameterRules 处理器：处理 GET /providers/{providerId}/models/{modelId}/parameter-rules 请求
  - 使用 ResponseData[T] 格式包装所有响应
  - 实现完整的错误处理，返回正确的HTTP状态码
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 8.4, 8.5_

- [x] 6. 实现路由注册
  - 创建 `internal/api/routes/provider_routes.go` 文件
  - 注册所有提供商相关的API路由
  - 使用 Go 1.22+ 的新路由模式定义路径参数
  - _需求: 3.1, 4.1, 5.1, 6.1, 7.1_

- [x] 7. 集成到应用启动流程
  - 修改 `cmd/server/main.go` 文件
  - 在应用启动时创建内存存储实例
  - 创建数据加载器并执行数据加载
  - 创建服务层和处理器层实例
  - 注册路由并启动HTTP服务器
  - 添加启动日志和错误处理
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 8.1, 8.6_

- [x] 8. 添加配置管理
  - 在 `internal/config/` 目录下添加模型目录配置
  - 支持通过环境变量或配置文件指定 models 目录路径
  - 提供默认配置值
  - _需求: 1.1, 2.1_

- [x] 9. 添加输入验证和安全检查
  - 在处理器层添加路径参数验证
  - 验证 providerId 和 modelId 的格式（只允许字母、数字、下划线、连字符）
  - 限制参数长度
  - 在加载器中添加路径安全检查，防止目录遍历攻击
  - _需求: 8.4_

- [ ]* 10. 编写单元测试
  - [ ]* 10.1 为内存存储编写单元测试
    - 测试并发读写安全性
    - 测试数据的正确存储和检索
    - 测试错误情况处理
    - _需求: 2.5_
  - [ ]* 10.2 为数据加载器编写单元测试
    - 使用 testdata 目录创建测试用的 YAML 文件
    - 测试正常加载流程
    - 测试文件不存在、YAML 格式错误等异常情况
    - 测试 _position.yaml 存在和不存在两种情况
    - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7_
  - [ ]* 10.3 为服务层编写单元测试
    - 使用 mock Store 接口
    - 测试所有服务方法的正常流程
    - 测试各种错误情况
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_
  - [ ]* 10.4 为处理器层编写单元测试
    - 使用 mock Service 接口
    - 测试所有 API 端点的正常响应
    - 测试错误响应和 HTTP 状态码
    - 验证响应格式符合 ResponseData[T] 规范
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [ ]* 11. 编写集成测试
  - 创建 `test/integration/provider_api_test.go` 文件
  - 测试完整的数据加载流程
  - 测试所有 API 端点的端到端调用
  - 使用真实的 models 目录中的 YAML 文件
  - 测试并发请求处理
  - _需求: 1.1, 1.2, 1.3, 1.4, 1.5, 2.1, 2.2, 2.3, 2.4, 2.5, 2.6, 2.7, 3.1, 3.2, 3.3, 3.4, 3.5, 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 6.1, 6.2, 6.3, 6.4, 6.5, 6.6, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [ ]* 12. 添加健康检查端点
  - 创建健康检查处理器
  - 实现 GET /health 端点
  - 返回服务状态、提供商数量、模型数量等信息
  - _需求: 8.1_

- [ ]* 13. 完善日志记录
  - 确保所有关键操作都有日志记录
  - 使用结构化日志格式
  - 添加请求追踪信息
  - _需求: 8.1, 8.2, 8.3, 8.6_

- [ ]* 14. 编写API文档
  - 创建 README 文档说明如何使用 API
  - 提供每个端点的请求和响应示例
  - 说明错误码和错误消息
  - 提供部署和配置说明
